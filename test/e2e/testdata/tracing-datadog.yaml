apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: eg-special-case-datadog
  namespace: gateway-conformance-infra
spec:
  gatewayClassName: "{GATEWAY_CLASS_NAME}"
  listeners:
    - name: http
      port: 80
      protocol: HTTP
      allowedRoutes:
        namespaces:
          from: All
  infrastructure:
    parametersRef:
      group: gateway.envoyproxy.io
      kind: EnvoyProxy
      name: datadog-tracing
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: monitoring
data:
  config.alloy: |
    logging {
      level  = "debug"
      format = "logfmt"
    }

    otelcol.processor.batch "default" {
      output {
        metrics = [otelcol.exporter.otlp.default.input]
        traces  = [otelcol.exporter.otlp.default.input]
      }
    }

    otelcol.processor.deltatocumulative "default" {
      max_stale = "5m"
      max_streams = 100
      output {
        metrics = [otelcol.processor.batch.default.input]
      }
    }

    otelcol.exporter.otlp "default" {
      client {
        endpoint = "otel-collector:4317"
        tls {
          insecure = true
        }
      }
    }

    otelcol.receiver.datadog "default" {
      endpoint = "0.0.0.0:8126"
      output {
        metrics = [otelcol.processor.deltatocumulative.default.input]
        traces  = [otelcol.processor.batch.default.input]
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alloy-deployment
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alloy
  template:
    metadata:
      labels:
        app: alloy
    spec:
      containers:
        - name: alloy
          image: grafana/alloy:v1.4.2
          volumeMounts:
            - name: config-volume
              mountPath: /etc/alloy/config.alloy
              subPath: config.alloy
          command: ["alloy", "run", "--stability.level=experimental", "--server.http.listen-addr=0.0.0.0:12345", "--storage.path=/var/lib/alloy/data", "/etc/alloy/config.alloy"]
      volumes:
        - name: config-volume
          configMap:
            name: alloy-config
---
apiVersion: v1
kind: Service
metadata:
  name: alloy-collector
  namespace: monitoring
spec:
  selector:
    app: alloy
  ports:
    - protocol: TCP
      port: 8126
      targetPort: 8126
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: datadog-tracing
  namespace: gateway-conformance-infra
spec:
  logging:
    level:
      default: debug
  telemetry:
    tracing:
      provider:
        type: Datadog
        backendRefs:
          - name: alloy-collector
            namespace: monitoring
            port: 8126
      customTags:
        "provider":
          type: Literal
          literal:
            value: "datadog"
        "k8s.cluster.name":
          type: Literal
          literal:
            value: "envoy-gateway"
        "k8s.pod.name":
          type: Environment
          environment:
            name: ENVOY_POD_NAME
            defaultValue: "-"
        "k8s.namespace.name":
          type: Environment
          environment:
            name: ENVOY_GATEWAY_NAMESPACE
            defaultValue: "envoy-gateway-system"
  shutdown:
    drainTimeout: 5s
    minDrainDuration: 1s
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: tracing-datadog
  namespace: gateway-conformance-infra
spec:
  parentRefs:
    - name: eg-special-case-datadog
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /datadog
      backendRefs:
        - name: infra-backend-v2
          port: 8080
